<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload Prijslijst - GHX</title>
  <style>
    :root{
      /* Kleuren (GHX huisstijl) */
      --ghx-blue:   #474747;
      --ghx-orange: #f26a21;
      --panel-gray: #f5f5f5;
      --panel-border:#e6e6e6;
      --ink: #1b1b1b;
      --bg: #ffffff;
      --text-gray: #6c757d;
      --light-blue: #f5f5f5;
    }

    /* Basis */
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      line-height: 1.5;
    }

    /* Blauwe topbalk */
    .topbar{
      background: var(--ghx-blue);
      height: 96px;
      display:flex;
      align-items:center;
    }
    .topbar__inner{
      width:min(1200px, 94vw);
      margin-inline:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .logo-wrap{
      display:flex; align-items:center; gap:2px;
    }
    .logo{
      height:75px; display:block;
    }
    /* User pill verwijderd voor cleaner look */

    /* Oranje navigatiebalk (dunner) */
    .nav{
      background: var(--ghx-orange);
      height: 32px;
    }
    .nav__inner{ width:min(1200px, 94vw); margin-inline:auto; height:100%; }

    /* Page title */
    .page-header{
      width:min(800px, 94vw);
      margin: 24px auto 20px;
      text-align: left;
    }
    .page-title{
      font-size: 24px;
      font-weight: 600;
      color: var(--ink);
      margin: 0;
    }

    /* Progress steps zoals in screenshot */
    .progress-container{
      width:min(1200px, 94vw);
      margin: 0 auto 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .progress-step{
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-gray);
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      cursor: default;
      transition: all 0.2s ease;
      min-width: 32px;
      flex-shrink: 0;
    }
    .progress-step.clickable{
      cursor: pointer;
    }
    .progress-step.clickable:hover{
      transform: scale(1.05);
    }
    .progress-step.large{
      width: 48px;
      height: 48px;
      font-size: 10px;
      min-width: 48px;
      flex-shrink: 0;
    }
    .progress-step.active{
      background: var(--ghx-orange);
      color: var(--ghx-blue);
      border-color: var(--ghx-orange);
    }
    .progress-step.completed{
      background: var(--ghx-blue);
      color: var(--ghx-orange);
      border-color: var(--ghx-blue);
    }
    .progress-line{
      width: 32px;
      height: 2px;
      background: #e9ecef;
      flex-shrink: 0;
    }
    .progress-line.completed{
      background: var(--ghx-blue);
    }

    /* Content en panelen zoals in screenshot */
    .content{
      width:min(680px, 94vw);
      margin: 0 auto 48px;
      display:block;
    }

    .panel{
      background: var(--panel-gray);
      border: 1px solid var(--panel-border);
      border-radius: 6px;
      min-height: 320px;
      position: relative;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }

    /* Klein oranje tabje linksboven zoals in screenshot */
    .panel::before{
      content:"";
      position:absolute;
      top:0; left:0;
      width: 58px; height: 8px;
      background: var(--ghx-orange);
      border-top-left-radius:6px;
      border-bottom-right-radius:6px;
    }

    .panel__body{ 
      padding: 20px;
    }

    .panel__title{
      font-size: 16px;
      font-weight: 600;
      color: var(--ink);
      margin: 0 0 16px 0;
    }

    /* Form styling zoals in screenshot */
    .form-group{
      margin-bottom: 20px;
    }
    .form-label{
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--ink);
      font-size: 14px;
    }
    .form-control{
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
      background: white;
    }
    .form-control:focus{
      outline: none;
      border-color: var(--ghx-orange);
    }

    /* Radio buttons zoals in screenshot */
    .radio-group{
      display: flex;
      gap: 24px;
      margin-top: 8px;
    }
    .radio-item{
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    .radio-item input[type="radio"]{
      accent-color: var(--ghx-orange);
    }

    /* Multi-select zoals in screenshot */
    .multi-select{
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 80px;
      padding: 4px;
      background: white;
      font-size: 14px;
    }
    .multi-select option{
      padding: 4px 8px;
    }

    /* Buttons zoals in screenshot */
    .btn{
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: white;
    }
    .btn:hover{
      background: #f8f9fa;
    }
    .btn-primary{
      background: var(--ghx-orange);
      color: white;
      border-color: var(--ghx-orange);
    }
    .btn-primary:hover{
      background: #e55a00;
      border-color: #e55a00;
    }
    .btn-cancel{
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }
    .btn-cancel:hover{
      background: #c82333;
    }
    .btn:disabled{
      opacity: 0.5;
      cursor: not-allowed !important;
    }
    .btn:not(:disabled){
      cursor: pointer !important;
    }

    /* Document items zoals in screenshot */
    .doc-item{
      background: var(--light-blue);
      border: 1px solid #bbdefb;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .doc-icon{
      width: 20px;
      height: 20px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>') no-repeat;
      background-size: contain;
      flex-shrink: 0;
      opacity: 0.7;
    }
    .doc-content{
      flex: 1;
    }
    .doc-title{
      font-weight: 500;
      color: #1565c0;
      margin-bottom: 2px;
      font-size: 14px;
    }
    .doc-subtitle{
      font-size: 12px;
      color: var(--text-gray);
    }

    /* Context preview zoals in screenshot */
    .context-preview{
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #333;
      white-space: pre-wrap;
      max-height: 120px;
      overflow-y: auto;
    }

    /* Download section */
    .download-section{
      border-top: 1px solid var(--panel-border);
      padding-top: 16px;
      margin-top: 16px;
    }
    .download-title{
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--ghx-blue);
    }

    /* Voorwaarden lijst */
    .conditions-list{
      font-size: 12px;
      color: var(--text-gray);
      margin: 16px 0;
      padding-left: 16px;
    }
    .conditions-list li{
      margin-bottom: 8px;
    }

    /* Geavanceerde configuratie */
    .advanced-config{
      border: 1px solid #ddd;
      border-radius: 4px;
      margin: 16px 0;
    }
    .advanced-toggle{
      background: #f8f9fa;
      padding: 12px 16px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--ghx-blue);
    }
    .advanced-content{
      padding: 16px;
      background: white;
      display: none;
    }
    .advanced-content.open{
      display: block;
    }

    /* Responsive */
    @media (max-width: 960px){
      .content{ 
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .panel{ min-height: 200px; }
    }

    /* Utility classes */
    .text-center{ text-align: center; }
    .text-muted{ color: var(--text-gray); }
    .mb-0{ margin-bottom: 0; }
    .mb-2{ margin-bottom: 8px; }
    .hidden{ display: none; }
  </style>
</head>
<body>

  <!-- Blauwe header met logo -->
  <header class="topbar">
    <div class="topbar__inner">
      <div class="logo-wrap">
        <img src="static/ghx_logo.png" alt="GHX" class="logo">
      </div>

    </div>
  </header>

  <!-- Oranje navigatiebalk (dunner) -->
  <div class="nav">
    <div class="nav__inner"></div>
  </div>

  <!-- Page title -->
  <div class="page-header">
    <h1 class="page-title">GHX Template Generator</h1>
  </div>

  <!-- Progress indicator -->
  <div class="progress-container" id="progress-container">
    <!-- Progress steps will be dynamically generated -->
  </div>

  <!-- Main content: Wizard -->
  <main class="content">
    
    <!-- Wizard Panel -->
    <section class="panel">
      <div class="panel__body">
        <h3 class="panel__title" id="wizard-title">Templatekeuze</h3>
        
        <!-- Wizard content will be dynamically inserted here -->
        <div id="wizard-content">
          Loading wizard...
        </div>

      </div>
    </section>

  </main>

  <script>
    // API Configuration
    const API_BASE = 'http://127.0.0.1:8080/api';
    
    // Global state
    let currentStep = 0; // Start met welkomstpagina
    let completedSteps = new Set([0]); // Start is altijd "voltooid"
    let templateGenerated = false; // Of er al een template is gegenereerd
    let lastGeneratedResult = null; // Laatste generatie resultaat
    let wizardData = {
      template_choice: 'standard',
      all_orderable: null,

      has_chemicals: null,
      is_staffel_file: null,
      gs1_mode: null,
      institutions: [],
      version: "v1.0.0"
    };
    let generatedFileId = null;

    // Step titles and content
    const stepTitles = [
      "Welkom",
      "Bestelbaarheid", 
      "Producttype",
      "Chemicaliën",
      "Staffelprijzen",
      "GS1 Integratie",
      "Zorginstellingen",
      "Overzicht",
      "Eind"
    ];

    const stepContent = {
      0: {
        title: "Op maat gemaakte prijslijsten voor GHX-leveranciers",
        type: 'welcome',
        description: `
          <p>Onze standaard prijslijsttemplate bevat 103 kolommen om te voldoen aan de eisen en wensen van verschillende zorginstellingen en organisaties. Dat is compleet, maar niet alle kolommen zijn relevant voor elke leverancier en voor elke organisatie.</p>
          
        <p>Met deze tool stelt u eenvoudig een op maat gemaakte template samen, afgestemd op:</p>
        <ul>
          <li>uw productassortiment</li>
          <li>uw doelgroep binnen de zorg</li>
          <li>en uw manier van aanleveren (bijvoorbeeld met of zonder GS1)</li>
        </ul>

        <p>Zo voorkomt u overbodige velden, ziet u in één oogopslag wat verplicht is, en bespaart u tijd bij het invullen.</p>

        <p><strong>Laten we beginnen...</strong></p>
        `,
                    actions: [
              {
                type: 'wizard',
                title: 'Op maat gemaakt GHX prijstemplate',
                description: 'Start de vragenlijst voor een aangepaste GHX prijstemplate',
                action: 'startWizard'
              },
              {
                type: 'download',
                title: 'Volledige GHX prijstemplate Downloaden',
                description: 'Download de standaard GHX prijstemplate met alle 103 kolommen zichtbaar',
                action: 'downloadStandardTemplate'
              }
            ]
      },
      1: {
        title: "Productcategorieën",
        type: 'multiple_choice',
        question: "Welke productcategorieën komen in deze prijslijst voor?",
        description: "Selecteer alle categorieën die in uw bestand voorkomen. Dit bepaalt welke velden zichtbaar blijven.<br><br><strong>• Kiest u één categorie</strong> → velden voor andere categorieën worden verborgen.<br><strong>• Kiest u meerdere categorieën</strong> → we tonen de velden van alle gekozen categorieën (gemengde lijst).<br><br><strong>Twijfelt u?</strong> Voeg de categorie dan toe. Staat er bijvoorbeeld ook maar één medisch, lab- of facilitair product in uw bestand, vink die categorie dan altijd aan.",
        options: [
          {
            key: 'product_types',
            value: 'facilitair',
            title: 'Facilitair',
            description: 'Kantoorbenodigdheden, meubilair, schoonmaak, logistiek, catering, algemene ziekenhuisartikelen.'
          },
          {
            key: 'product_types',
            value: 'medisch',
            title: 'Medisch',
            description: 'Medische hulpmiddelen, implantaten, devices, IVD\'s.'
          },
          {
            key: 'product_types',
            value: 'lab',
            title: 'Laboratorium',
            description: 'Reagentia, chemicaliën, labartikelen, labapparatuur.'
          },
          {
            key: 'product_types',
            value: 'overige',
            title: 'Overige',
            description: 'Diensten, software, onderhoud, consultancy, overige productgroepen.'
          }
        ]
      },
      2: {
        title: "Chemicaliën en gevaarlijke stoffen",
        question: "Bevat uw prijslijst producten met chemicaliën of gevaarlijke stoffen?",
        description: "Als uw producten chemicaliën of gevaarlijke stoffen bevatten, zijn extra gegevens vereist in de template.<br>Denk aan SDS-veiligheidsbladen, UN-nummers voor transport of temperatuurspecificaties.<br>Dit geldt bijvoorbeeld voor schoonmaakmiddelen, desinfectiemiddelen en laboratoriumreagentia.",
        options: [
          {
            key: 'has_chemicals',
            value: false,
            title: 'Nee, er zijn geen producten met chemicaliën of gevaarlijke stoffen'
          },
          {
            key: 'has_chemicals',
            value: true,
            title: 'Ja, er zijn producten met chemicaliën of gevaarlijke stoffen'
          }
        ]
      },
      3: {
        title: "Staffelprijzen",
        question: "Wilt u voor deze prijslijst later staffelprijzen aanleveren?",
        description: "Een staffelbestand bevat artikelen waarbij de prijs verandert bij grotere hoeveelheden.<br>Door hier <strong>Ja</strong> te kiezen, worden twee staffelkolommen zichtbaar in deze template.<br><br><strong>Let op:</strong> Het daadwerkelijke staffelbestand levert u pas later aan, nadat de reguliere prijslijst is goedgekeurd door de zorginstelling. Deze optie is bedoeld om nu alvast staffelprijzen voor te bereiden indien gewenst.",
        options: [
          {
            key: 'is_staffel_file',
            value: false,
            title: 'Nee, ik lever geen staffelprijzen aan voor deze prijslijst'
          },
          {
            key: 'is_staffel_file',
            value: true,
            title: 'Ja, ik wil later ook staffelprijzen aanleveren'
          }
        ]
      },
      4: {
        title: "GS1 Datasynchronisatie",
        question: "Wilt u via GHX uw productdata delen met het GS1 GDSN-netwerk?",
        description: "Als u uw prijslijst via GHX aanlevert, kunt u ervoor kiezen om uw artikelen tegelijk te delen via het GS1 Global Data Synchronisation Network (GDSN).<br><br>Dit wereldwijde netwerk maakt het mogelijk om productinformatie veilig en uniform te delen met zorginstellingen en andere afnemers. Kiest u voor GDSN, dan worden extra velden in de template zichtbaar die daarvoor verplicht zijn – zoals hiërarchie-omschrijvingen, taalcodes en GLN-codes.<br><br>Voor meer informatie over deze optie, neem contact op met <a href='mailto:operations.nl@ghxeurope.com'>operations.nl@ghxeurope.com</a>.",
        options: [
          {
            key: 'gs1_mode',
            value: 'none',
            title: 'Nee, alleen voor zorginstellingen en organisaties via GHX'
          },
          {
            key: 'gs1_mode',
            value: 'gs1',
            title: 'Ja, ook aanleveren aan GS1 GDSN'
          },
          {
            key: 'gs1_mode',
            value: 'gs1_only',
            title: 'Ja, maar alleen GS1 GDSN (geen prijsinformatie)',
            description: 'Bij deze keuze wordt stap 5 overgeslagen.'
          }
        ]
      },
      5: {
        title: "Zorginstellingen & Organisaties",
        question: "Voor welke zorginstellingen en/of organisaties levert u de prijslijst aan?",
        description: "Elke zorginstelling hanteert eigen vereisten voor verplichte velden in de prijslijst. Kiest u voor alle zorginstellingen, dan bevat uw template de volledige set verplichte velden. Selecteert u slechts één of enkele instellingen, dan worden alleen de velden verplicht die zij vragen, aangevuld met de standaard GHX-velden.<br><br><strong>Twijfelt u?</strong> Voeg de instelling liever toe, zodat u geen verplichte velden mist.<br><br>Is uw prijslijst bedoeld voor algemeen gebruik? Kies dan de optie <strong>Algemeen gebruik</strong> (Geen specifieke instelling). U ontvangt dan een template met alleen de standaardvereisten van GHX – zonder aanvullende velden van zorginstellingen of organisaties.",
        type: 'multiselect',
        options: [
          {
            value: '<strong>Algemeen gebruik</strong> (Geen specifieke instelling)'
          },
          'Amsterdam UMC (AMC & VUmc)',
          'Leids Universitair Medisch Centrum (LUMC)', 
          'Maastricht UMC+',
          'Universitair Medisch Centrum Groningen (UMCG)',
          'Universitair Medisch Centrum Utrecht (UMCU)',
          'Hospital Logistics',
          'Noordwest Ziekenhuisgroep',
          'Parnassia Groep',
          'Prinses Máxima Centrum',
          'Prothya Biosolutions',
          'Sanquin',
          'Universiteit Leiden',
          'Universiteit Utrecht',
          'Universiteit van Amsterdam',
          'Zorgservice XL'
        ]
      },
      6: {
        title: "Overzicht",
        description: "Controleer uw antwoorden voordat we het template genereren.",
        type: 'summary'
      }
    };

    // Wizard functions
    function renderStep(step) {
      const stepData = stepContent[step];
      const wizardContent = document.getElementById('wizard-content');
      const wizardTitle = document.getElementById('wizard-title');
      
      // Update progress indicator
      updateProgressIndicator(step);
      
      wizardTitle.textContent = stepData.title;
      
      let html = '';
      
      if (stepData.type === 'welcome') {
        // Welcome page with actions
        html = `
          <div style="color: var(--text-gray); margin-bottom: 32px; line-height: 1.7;">
            ${stepData.description}
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 6px; margin: 18px 0;">
            ${stepData.actions.map(action => {
              if (action.type === 'download') {
                return `
                  <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 40px;">
                    <div style="border: 2px solid var(--ghx-orange); border-radius: 8px; padding: 12px 24px; cursor: pointer; transition: all 0.3s ease; background: white; max-width: 300px;" onclick="${action.action}()">
                      <h4 style="margin: 0; color: var(--text-gray); font-size: 16px; text-align: center; font-weight: 600;">${action.title}</h4>
                    </div>
                    <p style="margin: 0; color: var(--text-gray); font-size: 12px; text-align: center; max-width: 300px; line-height: 1.4;">${action.description}</p>
                  </div>
                `;
              } else {
                return `
                  <div style="border: 2px solid var(--ghx-orange); border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.3s ease; background: white;" onclick="${action.action}()">
                    <h4 style="margin: 0 0 8px 0; color: var(--ghx-orange); font-size: 18px; font-weight: 600; text-align: center;">${action.title}</h4>
                    <p style="margin: 0; color: var(--text-gray); font-size: 14px; text-align: center;">${action.description}</p>
                  </div>
                `;
              }
            }).join('')}
          </div>
        `;
        
      } else if (stepData.type === 'multiselect') {
        // Multi-select for organizations with prominent question
        html = '';
        
        // Prominent question
        if (stepData.question) {
          html += `
            <h3 style="color: var(--ghx-blue); font-size: 20px; font-weight: 600; margin-bottom: 16px; line-height: 1.4;">
              ${stepData.question}
            </h3>
          `;
        }
        
        // Optional description
        if (stepData.description) {
          html += `
            <p style="color: var(--text-gray); margin-bottom: 24px; line-height: 1.6;">
              ${stepData.description}
            </p>
          `;
        }
        
        html += `
          <div style="margin: 20px 0; text-align: center;">
            <button class="btn" onclick="selectAllOrgs()" style="margin-right: 10px;">Selecteer alle</button>
            <button class="btn" onclick="selectNFUOrgs()" style="margin-right: 10px;">Alle NFU ziekenhuizen</button>
            <button class="btn" onclick="deselectAllOrgs()">Deselecteer alle</button>
            <div style="margin-top: 10px; color: var(--text-gray);" id="org-counter">0 geselecteerd</div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin: 16px 0;">
        `;
        
        // Mapping van verkorte interface namen naar interne API keys
        const displayNameToApiKey = {
          '<strong>Algemeen gebruik</strong> (geen specifieke instelling)': 'geen_specifieke_instelling',
          'Amsterdam UMC (AMC & VUmc)': 'amsterdam_umc_(locaties_amc_en_vumc)',
          'Leids Universitair Medisch Centrum (LUMC)': 'leids_universitair_medisch_centrum_(lumc,_leiden)',
          'Maastricht UMC+': 'maastricht_umc+',
          'Universitair Medisch Centrum Groningen (UMCG)': 'universitair_medisch_centrum_groningen_(umcg)',
          'Universitair Medisch Centrum Utrecht (UMCU)': 'universitair_medisch_centrum_utrecht_(umc_utrecht)',
          'Hospital Logistics': 'hospital_logistics_(oss)',
          'Noordwest Ziekenhuisgroep': 'noordwest_ziekenhuisgroep',
          'Parnassia Groep': 'parnassia_groep',
          'Prinses Máxima Centrum': 'prinses_máxima_centrum_voor_kinderoncologie',
          'Prothya Biosolutions': 'prothya_biosolutions',
          'Sanquin': 'sanquin_(nationale_bloedbank)',
          'Universiteit Leiden': 'universiteit_leiden',
          'Universiteit Utrecht': 'universiteit_utrecht_(uu)',
          'Universiteit van Amsterdam': 'universiteit_van_amsterdam_(uva)',
          'Zorgservice XL': 'zorgservice_xl'
        };

        stepData.options.forEach((org, index) => {
          let orgLabel, orgValue, orgDescription;
          if (typeof org === 'object' && org.value) {
            orgLabel = org.value;
            orgDescription = org.description;
            orgValue = displayNameToApiKey[orgLabel] || orgLabel.toLowerCase().replace(/ /g, '_');
          } else {
            orgLabel = org;
            orgDescription = undefined;
            orgValue = displayNameToApiKey[orgLabel] || orgLabel.toLowerCase().replace(/ /g, '_');
          }
          const isChecked = wizardData.institutions.includes(orgValue);
          html += `
            <div class="org-option" onclick="toggleOrganization('${orgValue}', this)" 
                 style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 16px; 
                        border: 2px solid ${isChecked ? 'var(--ghx-orange)' : 'var(--panel-border)'}; 
                        border-radius: 8px; cursor: pointer; transition: all 0.3s ease; 
                        background: ${isChecked ? '#fff7ed' : 'var(--bg)'}; font-size: 14px;
                        font-weight: ${isChecked ? '600' : '400'}; text-align: center;">
              <input type="checkbox" name="institutions" value="${orgValue}" ${isChecked ? 'checked' : ''} style="display: none;">
              ${orgLabel}
              ${orgDescription ? `<div style="color: var(--text-gray); font-size: 12px; margin-top: 4px;">${orgDescription}</div>` : ''}
            </div>
          `;
        });
        
        html += `</div>`;
        
      } else if (stepData.type === 'multiple_choice') {
        // Multiple choice checkboxes
        html = '';
        
        // Prominent question
        if (stepData.question) {
          html += `
            <h3 style="color: var(--ghx-orange); font-size: 20px; font-weight: 600; margin-bottom: 16px; line-height: 1.4;">
              ${stepData.question}
            </h3>
          `;
        }
        
        // Optional description
        if (stepData.description) {
          html += `
            <p style="color: var(--text-gray); margin-bottom: 24px; line-height: 1.6;">
              ${stepData.description}
            </p>
          `;
        }
        
        html += '<div style="display: grid; gap: 12px; margin: 16px 0;">';
        
        stepData.options.forEach(option => {
          const isSelected = wizardData[option.key] && wizardData[option.key].includes(option.value);
          html += `
            <div class="checkbox-option" onclick="toggleCheckbox('${option.key}', '${option.value}', this)" 
                 style="border: 2px solid ${isSelected ? 'var(--ghx-orange)' : 'var(--panel-border)'}; 
                        border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.3s ease; 
                        background: ${isSelected ? '#fff7ed' : 'var(--bg)'}; font-weight: ${isSelected ? '600' : '400'};">
              <h4 style="margin: 0 0 8px 0; color: var(--ink); font-size: 16px; font-weight: 600;">${option.title}</h4>
              ${option.description ? `<p style="margin: 0; color: var(--text-gray); font-size: 14px;">${option.description}</p>` : ''}
            </div>
          `;
        });
        
        html += '</div>';
        
      } else if (stepData.type === 'summary') {
        // Summary view
        html = `
          <p style="color: var(--text-gray); margin-bottom: 24px; line-height: 1.6;">
            ${stepData.description}
          </p>
          <div id="summary-content">Loading summary...</div>
        `;
        
      } else {
        // Regular options with prominent question
        html = '';
        
        // Prominent question if exists
        if (stepData.question) {
          html += `
            <h3 style="color: var(--ghx-orange); font-size: 20px; font-weight: 600; margin-bottom: 16px; line-height: 1.4;">
              ${stepData.question}
            </h3>
          `;
        }
        
        // Optional description
        if (stepData.description) {
          html += `
            <p style="color: var(--text-gray); margin-bottom: 24px; line-height: 1.6;">
              ${stepData.description}
            </p>
          `;
        }
        
        html += '<div style="display: grid; gap: 12px; margin: 16px 0;">';
        
        stepData.options.forEach(option => {
          const isSelected = wizardData[option.key] === option.value;
          html += `
            <div class="option-card" onclick="selectOption('${option.key}', ${typeof option.value === 'string' ? `'${option.value}'` : option.value}, this)" 
                 style="border: 2px solid ${isSelected ? 'var(--ghx-orange)' : 'var(--panel-border)'}; 
                        border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.3s ease; 
                        background: ${isSelected ? '#fff7ed' : 'var(--bg)'};">
              <h4 style="margin: 0; color: var(--ink); font-size: 16px; font-weight: 600;">${option.title}</h4>
              ${option.description ? `<p style="margin: 8px 0 0 0; color: var(--text-gray); font-size: 14px;">${option.description}</p>` : ''}
            </div>
          `;
        });
        
        html += '</div>';
      }
      
      // Info box
      if (stepData.info) {
        html += `
          <div style="background: var(--light-blue); border: 1px solid #93c5fd; border-radius: 8px; padding: 16px; margin: 20px 0;">
            ${stepData.info}
          </div>
        `;
      }
      
      // Navigation buttons (niet voor welcome page)
      if (stepData.type !== 'welcome') {
        const canGoNext = step === 0 || (step === 5 ? wizardData.institutions.length > 0 : hasValidSelection(step));
        html += `
          <div style="display: flex; justify-content: space-between; gap: 16px; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--panel-border);">
            <button class="btn" onclick="previousStep()" ${step <= 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>Vorige</button>
            ${step === 6 ? 
              '<button class="btn btn-primary" onclick="generateTemplate()">Template genereren</button>' :
              `<button class="btn ${canGoNext ? 'btn-primary' : ''}" onclick="nextStep()" id="step-${step}-next" ${!canGoNext ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>Volgende</button>`
            }
          </div>
        `;
      }
      
      wizardContent.innerHTML = html;
      
      // Update summary if step 6
      if (step === 6) {
        updateSummary();
      }
      
      // Update org counter if step 5 (zonder template te invalideren)
      if (step === 5) {
        setTimeout(() => updateOrgCounter(false), 100);
      }
    }

    function selectOption(key, value, element) {
      // Remove selection from siblings
      element.parentElement.querySelectorAll('.option-card').forEach(card => {
        card.style.borderColor = 'var(--panel-border)';
        card.style.background = 'var(--bg)';
      });
      
      // Add selection to clicked element
      element.style.borderColor = 'var(--ghx-orange)';
      element.style.background = '#fff7ed';
      
      // Store value
      wizardData[key] = value;
      
      // Als er iets wordt gewijzigd en er was al een template gegenereerd,
      // invalideren we die zodat er een nieuwe moet worden gegenereerd
      if (templateGenerated) {
        templateGenerated = false;
        completedSteps.delete(8); // Eind is niet meer voltooid
        updateProgressIndicator(currentStep); // Update de visual state
      }
      
      // Enable next button with proper styling
      const nextBtn = document.getElementById(`step-${currentStep}-next`);
      if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.className = 'btn btn-primary';
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
        nextBtn.removeAttribute('disabled');
      }
    }

    function toggleCheckbox(key, value, element) {
      // Initialize array if it doesn't exist
      if (!wizardData[key]) {
        wizardData[key] = [];
      }
      
      const isSelected = wizardData[key].includes(value);
      
      if (isSelected) {
        // Remove from array
        wizardData[key] = wizardData[key].filter(item => item !== value);
        element.style.borderColor = 'var(--panel-border)';
        element.style.background = 'var(--bg)';
        element.style.fontWeight = '400';
      } else {
        // Add to array
        wizardData[key].push(value);
        element.style.borderColor = 'var(--ghx-orange)';
        element.style.background = '#fff7ed';
        element.style.fontWeight = '600';
      }
      
      // Als er iets wordt gewijzigd en er was al een template gegenereerd,
      // invalideren we die zodat er een nieuwe moet worden gegenereerd
      if (templateGenerated) {
        templateGenerated = false;
        completedSteps.delete(8); // Eind is niet meer voltooid
        updateProgressIndicator(currentStep); // Update de visual state
      }
      
      // Enable next button if at least one option is selected
      const nextBtn = document.getElementById(`step-${currentStep}-next`);
      if (nextBtn && wizardData[key].length > 0) {
        nextBtn.disabled = false;
        nextBtn.className = 'btn btn-primary';
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
        nextBtn.removeAttribute('disabled');
      } else if (nextBtn && wizardData[key].length === 0) {
        nextBtn.disabled = true;
        nextBtn.className = 'btn';
        nextBtn.style.opacity = '0.5';
        nextBtn.style.cursor = 'not-allowed';
      }
    }

    function selectAllOrgs() {
      document.querySelectorAll('.org-option').forEach(element => {
        const checkbox = element.querySelector('input[type="checkbox"]');
        checkbox.checked = true;
        element.style.borderColor = 'var(--ghx-orange)';
        element.style.background = '#fff7ed';
        element.style.fontWeight = '600';
      });
      updateOrgCounter();
    }

    function deselectAllOrgs() {
      document.querySelectorAll('.org-option').forEach(element => {
        const checkbox = element.querySelector('input[type="checkbox"]');
        checkbox.checked = false;
        element.style.borderColor = 'var(--panel-border)';
        element.style.background = 'var(--bg)';
        element.style.fontWeight = '400';
      });
      updateOrgCounter();
    }

    function selectNFUOrgs() {
      // NFU ziekenhuizen lijst (Nederlandse Federatie van Universitair medische centra)
      const nfuOrganizations = [
        'amsterdam_umc_(locaties_amc_en_vumc)',
        'leids_universitair_medisch_centrum_(lumc,_leiden)',
        'maastricht_umc+',
        'universitair_medisch_centrum_groningen_(umcg)',
        'universitair_medisch_centrum_utrecht_(umc_utrecht)'
      ];
      
      // Eerst alles deselecteren
      document.querySelectorAll('.org-option').forEach(element => {
        const checkbox = element.querySelector('input[type="checkbox"]');
        checkbox.checked = false;
        element.style.borderColor = 'var(--panel-border)';
        element.style.background = 'var(--bg)';
        element.style.fontWeight = '400';
      });
      
      // Dan NFU ziekenhuizen selecteren
      document.querySelectorAll('.org-option').forEach(element => {
        const checkbox = element.querySelector('input[type="checkbox"]');
        const orgValue = checkbox.value;
        
        // Check of deze organisatie een NFU organisatie is (exacte match)
        if (nfuOrganizations.includes(orgValue)) {
          checkbox.checked = true;
          element.style.borderColor = 'var(--ghx-orange)';
          element.style.background = '#fff7ed';
          element.style.fontWeight = '600';
        }
      });
      
      updateOrgCounter();
    }

    function updateOrgCounter(invalidateTemplate = true) {
      const checked = document.querySelectorAll('input[name="institutions"]:checked');
      const newInstitutions = Array.from(checked).map(cb => cb.value);
      
      // Update element styling for all options
      document.querySelectorAll('.org-option').forEach(element => {
        const checkbox = element.querySelector('input[type="checkbox"]');
        if (checkbox.checked) {
          element.style.borderColor = 'var(--ghx-orange)';
          element.style.background = '#fff7ed';
          element.style.fontWeight = '600';
        } else {
          element.style.borderColor = 'var(--panel-border)';
          element.style.background = 'var(--bg)';
          element.style.fontWeight = '400';
        }
      });
      
      // Alleen invalideren als er daadwerkelijk iets is veranderd en invalidateTemplate=true
      const institutionsChanged = JSON.stringify(wizardData.institutions.sort()) !== JSON.stringify(newInstitutions.sort());
      
      wizardData.institutions = newInstitutions;
      
      // Alleen invalideren als er echt iets is veranderd EN invalidateTemplate is true
      if (templateGenerated && institutionsChanged && invalidateTemplate) {
        templateGenerated = false;
        completedSteps.delete(8); // Eind is niet meer voltooid
        updateProgressIndicator(currentStep); // Update de visual state
      }
      
      const counter = document.getElementById('org-counter');
      if (counter) {
        counter.textContent = `${checked.length} geselecteerd`;
      }
      
      // Enable next button if at least one is selected
      const nextBtn = document.getElementById(`step-${currentStep}-next`);
      if (nextBtn) {
        if (checked.length > 0) {
          nextBtn.disabled = false;
          nextBtn.className = 'btn btn-primary';
          nextBtn.style.opacity = '1';
          nextBtn.style.cursor = 'pointer';
          nextBtn.removeAttribute('disabled');
        } else {
          nextBtn.disabled = true;
          nextBtn.className = 'btn';
          nextBtn.style.opacity = '0.5';
          nextBtn.style.cursor = 'not-allowed';
        }
      }
    }

    function toggleOrganization(orgValue, element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      
      // Toggle state
      checkbox.checked = !checkbox.checked;
      
      // Update visual state
      if (checkbox.checked) {
        element.style.borderColor = 'var(--ghx-orange)';
        element.style.background = '#fff7ed';
        element.style.fontWeight = '600';
      } else {
        element.style.borderColor = 'var(--panel-border)';
        element.style.background = 'var(--bg)';
        element.style.fontWeight = '400';
      }
      
      // Update counter and state
      updateOrgCounter();
    }

    function nextStep() {
      if (currentStep < 6) {
        // Markeer huidige stap als voltooid
        completedSteps.add(currentStep);
        
        let nextStepNum = currentStep + 1;
        
        // Skip step 5 (institutions) if GS1-only mode is selected
        if (currentStep === 4 && wizardData.gs1_mode === 'gs1_only') {
          // Auto-fill minimal data for skipped step
          wizardData.institutions = ['GS1'];
          completedSteps.add(5); // Mark step 5 as completed
          nextStepNum = 6; // Jump directly to summary
        }
        
        goToStep(nextStepNum);
      }
    }

    function previousStep() {
      if (currentStep > 0) {
        let prevStepNum = currentStep - 1;
        
        // Skip step 5 (institutions) if going back from summary and GS1-only mode
        if (currentStep === 6 && wizardData.gs1_mode === 'gs1_only') {
          prevStepNum = 4; // Jump back to step 4 (GS1 configuration)
          completedSteps.delete(5); // Remove step 5 completion mark
        }
        
        goToStep(prevStepNum);
      }
    }

    function goToStep(step) {
      // Update progress indicator
      updateProgressIndicator(step);
      
      // Update current step
      currentStep = step;
      
      // Render new step
      renderStep(step);
    }

    function generateProgressIndicator() {
      const progressContainer = document.getElementById('progress-container');
      let html = '';
      
      for (let i = 0; i <= 7; i++) {
        if (i > 0) {
          html += '<div class="progress-line"></div>';
        }
        if (i === 0) {
          html += `<div class="progress-step large" data-step="${i}">Start</div>`;
        } else if (i === 7) {
          html += `<div class="progress-step large" data-step="${i}">Einde</div>`;
        } else {
          html += `<div class="progress-step" data-step="${i}">${i}</div>`;
        }
      }
      
      progressContainer.innerHTML = html;
      
      // Add event listeners after creating HTML
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.addEventListener('click', () => {
          console.log(`Clicked on step ${index}, calling navigateToStep(${index})`);
          navigateToStep(index);
        });
      });
    }

    function updateProgressIndicator(targetStep) {
      // Debug logging
      console.log(`updateProgressIndicator: targetStep=${targetStep}, templateGenerated=${templateGenerated}, completedSteps=`, completedSteps);
      
      // Update step circles
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        step.classList.remove('active', 'completed', 'clickable', 'skipped');
        
        // Bepaal wat de status moet zijn
        let stepStatus = 'default';
        
        // Check if step 5 should be skipped for GS1-only mode
        const isSkippedStep = (index === 5 && wizardData.gs1_mode === 'gs1_only');
        
        if (isSkippedStep) {
          stepStatus = 'skipped';
        } else if (index === targetStep) {
          stepStatus = 'active';
        } else if (completedSteps.has(index)) {
          stepStatus = 'completed';
        } else if (templateGenerated && index === 8) {
          // Speciale case: Eind balletje blijft altijd completed als template is gegenereerd
          stepStatus = 'completed';
        }
        
        // Voeg de juiste classes toe
        if (stepStatus === 'active') {
          step.classList.add('active', 'clickable');
        } else if (stepStatus === 'completed') {
          step.classList.add('completed', 'clickable');
        } else if (stepStatus === 'skipped') {
          step.classList.add('skipped');
          step.style.opacity = '0.4';
          step.style.background = '#e5e7eb';
        } else {
          // Reset skipped styling for non-skipped steps
          step.style.opacity = '';
          step.style.background = '';
        }
        
        console.log(`Step ${index}: status=${stepStatus}, classes=`, step.classList.toString());
      });
      
      // Update progress lines
      document.querySelectorAll('.progress-line').forEach((line, index) => {
        line.classList.remove('completed');
        if (completedSteps.has(index) || (templateGenerated && index === 7)) {
          line.classList.add('completed');
        }
      });
    }

    function hasValidSelection(step) {
      const stepData = stepContent[step];
      if (!stepData || !stepData.options) return false;
      
      // Check for multiple choice (arrays)
      if (stepData.type === 'multiple_choice') {
        const key = stepData.options[0]?.key;
        return key && wizardData[key] && wizardData[key].length > 0;
      }
      
      // Check if any option for this step is selected (regular single choice)
      return stepData.options.some(option => wizardData[option.key] === option.value);
    }

    function updateSummary() {
      const summaryContent = document.getElementById('summary-content');
      if (!summaryContent) return;

      const labels = {
        template_choice: wizardData.template_choice === 'standard' ? 'Op maat gemaakt template' : 'Op maat gemaakt template',
        product_types: wizardData.product_types ?
          wizardData.product_types.map(type => ({
            'facilitair': 'Facilitair',
            'medisch': 'Medisch',
            'lab': 'Laboratorium',
            'overige': 'Overige'
          }[type])).join(', ')
          : 'Geen selectie',
        has_chemicals: wizardData.has_chemicals ? 'Ja, er zijn producten met chemicaliën of gevaarlijke stoffen' : 'Nee, er zijn geen producten met chemicaliën of gevaarlijke stoffen',
        is_staffel_file: wizardData.is_staffel_file ? 'Ja, ik wil later ook staffelprijzen aanleveren' : 'Nee, ik lever geen staffelprijzen aan voor deze prijslijst',
        gs1_mode: wizardData.gs1_mode === 'gs1' ? 'Ja, ook aanleveren aan GS1 GDSN' : 
                 wizardData.gs1_mode === 'gs1_only' ? 'Ja, maar alleen GS1 GDSN (geen prijsinformatie)' : 
                 'Nee, alleen voor zorginstellingen en organisaties via GHX'
      };

      summaryContent.innerHTML = `
        <div style="background: white; border: 1px solid var(--panel-border); border-radius: 8px; padding: 20px; margin: 20px 0;">
          <h4 style="margin: 0 0 16px 0; color: var(--ghx-blue); font-size: 16px;">Uw antwoorden</h4>
          
          <div style="display: grid; gap: 16px;">
            <div style="border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;">
              <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 4px;">Template Type</div>
              <div style="font-size: 14px; color: var(--ink);">${labels.template_choice}</div>
            </div>
            
            <div style="border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;">
              <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 4px;">Productcategorieën</div>
              <div style="font-size: 14px; color: var(--ink);">${labels.product_types}</div>
            </div>
            
            <div style="border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;">
              <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 4px;">Chemicaliën</div>
              <div style="font-size: 14px; color: var(--ink);">${labels.has_chemicals}</div>
            </div>
            
            <div style="border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;">
              <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 4px;">Staffelbestand</div>
              <div style="font-size: 14px; color: var(--ink);">${labels.is_staffel_file}</div>
            </div>
            
            <div style="border-bottom: 1px solid #f0f0f0; padding-bottom: 12px;">
              <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 4px;">GS1 Integratie</div>
              <div style="font-size: 14px; color: var(--ink);">${labels.gs1_mode}</div>
            </div>
            
            <div>
              <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 4px;">Zorginstellingen en Organisaties</div>
              <div style="font-size: 14px; color: var(--ink);">
                ${wizardData.institutions.length} geselecteerd: ${
                  wizardData.institutions.map(inst => ({
                    'geen_specifieke_instelling': 'Algemeen gebruik (Geen specifieke instelling)',
                    'amsterdam_umc_(locaties_amc_en_vumc)': 'Amsterdam UMC (AMC & VUmc)',
                    'leids_universitair_medisch_centrum_(lumc,_leiden)': 'Leids Universitair Medisch Centrum (LUMC)',
                    'maastricht_umc+': 'Maastricht UMC+',
                    'universitair_medisch_centrum_groningen_(umcg)': 'Universitair Medisch Centrum Groningen (UMCG)',
                    'universitair_medisch_centrum_utrecht_(umc_utrecht)': 'Universitair Medisch Centrum Utrecht (UMCU)',
                    'hospital_logistics_(oss)': 'Hospital Logistics',
                    'noordwest_ziekenhuisgroep': 'Noordwest Ziekenhuisgroep',
                    'parnassia_groep': 'Parnassia Groep',
                    'prinses_máxima_centrum_voor_kinderoncologie': 'Prinses Máxima Centrum',
                    'prothya_biosolutions': 'Prothya Biosolutions',
                    'sanquin_(nationale_bloedbank)': 'Sanquin',
                    'universiteit_leiden': 'Universiteit Leiden',
                    'universiteit_utrecht_(uu)': 'Universiteit Utrecht',
                    'universiteit_van_amsterdam_(uva)': 'Universiteit van Amsterdam',
                    'zorgservice_xl': 'Zorgservice XL'
                  }[inst] || inst)).join(', ') || 'Geen'
                }
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Welcome page actions
    function downloadStandardTemplate() {
      console.log('🔽 Starting download of original template');
      
      // Direct download via window location with full URL
      window.location.href = 'http://localhost:8080/api/download-original-template';
    }

    function startWizard() {
      goToStep(1);
    }

    // Template generation
    async function generateTemplate() {
      // Hide current step and show generation
      document.getElementById('wizard-content').innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
          <h3 style="color: var(--ghx-blue); margin-bottom: 20px;">Template wordt gegenereerd...</h3>
          
          <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; height: 8px; margin: 20px 0; overflow: hidden;">
            <div id="gen-progress-bar" style="background: var(--ghx-orange); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          
          <div id="gen-status" style="color: var(--text-gray); margin: 10px 0;">
            Context valideren...
          </div>
        </div>
      `;
      
      const progressBar = document.getElementById('gen-progress-bar');
      const statusText = document.getElementById('gen-status');
      
      const steps = [
        { text: "Context valideren...", percent: 20 },
        { text: "Field mapping laden...", percent: 40 },
        { text: "Template engine initialiseren...", percent: 60 },
        { text: "Excel template genereren...", percent: 80 },
        { text: "Template succesvol gegenereerd!", percent: 100 }
      ];
      
      try {
        // Add timestamp in Dutch timezone (UTC+1/+2)
        const now = new Date();
        const dutchTime = new Date(now.getTime() + (2 * 60 * 60 * 1000)); // UTC+2 (summer time)
        wizardData.timestamp = dutchTime.toISOString().slice(0, 16).replace('T', '_').replace(/:/g, '');
        
        for (let i = 0; i < steps.length - 1; i++) {
          const step = steps[i];
          statusText.textContent = step.text;
          progressBar.style.width = step.percent + '%';
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Try real API call
        const response = await fetch(`${API_BASE}/generate-template`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(wizardData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          generatedFileId = result.file_id;
          showGenerationResult(result);
        } else {
          throw new Error(result.error || 'Onbekende fout');
        }
        
      } catch (error) {
        console.log('API error:', error);
        
        // Fallback to demo mode
        statusText.textContent = 'API niet beschikbaar - Demo mode';
        await new Promise(resolve => setTimeout(resolve, 500));
        
        showGenerationResult({
          success: true,
          filename: `ghx_prijstemplate_v25.1_DEMO_${wizardData.timestamp || 'generated'}.xlsx`,
          stats: { total_fields: 103, visible_fields: 82, mandatory_fields: 8 },
          preset_code: generatePresetCode(),
          file_size_kb: 1144.2
        });
      }
    }

    function generatePresetCode() {
      const parts = [
        (wizardData.product_type || 'mixed').toUpperCase().slice(0, 3),
        wizardData.gs1_mode === 'gs1' ? 'GS1' : 
        wizardData.gs1_mode === 'gs1_only' ? 'GS1ONLY' : 'NONE',
        wizardData.all_orderable ? 'ORDER' : 'PACK'
      ];
      return parts.join('-');
    }

    function showGenerationResult(result) {
      // Check of we al op de result pagina zijn
      const statusEl = document.getElementById('gen-status');
      const progressEl = document.getElementById('gen-progress-bar');
      
      if (statusEl) statusEl.textContent = "Template succesvol gegenereerd!";
      if (progressEl) progressEl.style.width = '100%';
      
      // Markeer dat er een template is gegenereerd en sla resultaat op
      templateGenerated = true;
      lastGeneratedResult = result;
      completedSteps.add(6); // Markeer overzicht als voltooid
      completedSteps.add(7); // Markeer Eind ook als voltooid zodat het klikbaar blijft
      
      // Ga naar stap 7 (Eind)
      currentStep = 7;
      updateProgressIndicator(7);
      
      // Verwijder de pagina titel
      document.getElementById('wizard-title').textContent = '';
      
      document.getElementById('wizard-content').innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <div style="background: #fff7ed; border: 2px solid var(--ghx-orange); border-radius: 8px; padding: 20px; margin: 10px 0;">
            <h3 style="color: var(--ghx-orange); margin: 0 0 8px 0;">Template Succesvol Gegenereerd!</h3>
            <p style="color: var(--ink); margin: 0;">Je aangepaste GHX prijstemplate is klaar voor download.</p>
          </div>
          
          <!-- Template Naam - Grote gecentreerde sectie -->
          <div style="background: #cdcdcd; border: 1px solid var(--panel-border); border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center;">
            <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 8px;">Template Bestandsnaam</div>
            <div style="font-size: 18px; font-weight: 600; color: var(--ink); word-break: break-all; line-height: 1.4;">${result.filename}</div>
          </div>
          
          <!-- Andere informatie in symmetrische layout -->
          <div style="margin: 20px 0;">
            <!-- Eerste rij: 3 vakjes -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
              <div style="background: #cdcdcd; border: 1px solid var(--panel-border); border-radius: 8px; padding: 16px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 6px;">Grootte</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--ink);">${result.file_size_kb} KB</div>
              </div>
              <div style="background: #cdcdcd; border: 1px solid var(--panel-border); border-radius: 8px; padding: 16px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 6px;">Preset Code</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--ink); font-family: monospace; text-align: left; padding-left: 20px;">${result.preset_code}</div>
              </div>
              <div style="background: #cdcdcd; border: 1px solid var(--panel-border); border-radius: 8px; padding: 16px; text-align: center;">
                <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 6px;">Zichtbare Velden</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--ink);">${result.stats.visible_fields} van ${result.stats.total_fields}</div>
              </div>
            </div>
            <!-- Tweede rij: 1 gecentreerd vakje -->
            <div style="display: flex; justify-content: center;">
              <div style="background: #cdcdcd; border: 1px solid var(--panel-border); border-radius: 8px; padding: 16px; text-align: center; width: 200px;">
                <div style="font-size: 12px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 6px;">Verplichte Velden</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--ink);">${result.stats.mandatory_fields} gemarkeerd</div>
              </div>
            </div>
          </div>

          <div style="margin: 30px 0;">
            <button class="btn btn-primary" onclick="downloadTemplate()" style="font-size: 18px; padding: 15px 40px;">
              Download Template
            </button>
          </div>

          <div style="display: flex; justify-content: center; gap: 16px;">
            <button class="btn" onclick="location.reload()">Nieuwe Template Maken</button>
            <button class="btn" onclick="goToStep(6)">Terug naar Overzicht</button>
          </div>
        </div>
      `;
    }

    function navigateToStep(targetStep) {
      console.log(`🔥 NAVIGATE TO STEP ${targetStep}`);
      console.log(`   currentStep=${currentStep}`);
      console.log(`   templateGenerated=${templateGenerated}`);
      console.log(`   completedSteps=`, Array.from(completedSteps));
      
      // Bepaal of navigatie toegestaan is
      const isCompleted = completedSteps.has(targetStep);
      const isCurrent = targetStep === currentStep;
      const isEndWithTemplate = (templateGenerated && targetStep === 7);
      
      console.log(`   isCompleted=${isCompleted}, isCurrent=${isCurrent}, isEndWithTemplate=${isEndWithTemplate}`);
      
      if (isCompleted || isCurrent || isEndWithTemplate) {
        console.log(`✅ Navigation allowed to step ${targetStep}`);
        
        // Als we naar Eind gaan en er is al een template gegenereerd, toon die
        if (targetStep === 7 && templateGenerated && lastGeneratedResult) {
          console.log(`📝 Showing generated result for step 7`);
          // Als we al op stap 7 zijn, hoeven we niets te doen
          if (currentStep === 7) {
            console.log(`Already on step 7, no action needed`);
          } else {
            showGenerationResult(lastGeneratedResult);
          }
        } else {
          console.log(`📍 Going to regular step ${targetStep}`);
          goToStep(targetStep);
        }
      } else {
        console.log(`❌ Navigation NOT allowed to step ${targetStep}`);
      }
    }

    async function downloadTemplate() {
      if (generatedFileId) {
        try {
          const response = await fetch(`${API_BASE}/download/${generatedFileId}`);
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Use the actual filename from API response instead of generating our own
            a.download = lastGeneratedResult?.filename || `ghx_prijstemplate_v25.1_${wizardData.timestamp || 'generated'}.xlsx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
          } else {
            throw new Error('Download gefaald');
          }
        } catch (error) {
          alert('Download gefaald. API mogelijk niet beschikbaar: ' + error.message);
        }
      } else {
        alert('Demo mode - In echte implementatie wordt hier het template gedownload!');
      }
    }

    // Initialize wizard
    document.addEventListener('DOMContentLoaded', function() {
      generateProgressIndicator();
      renderStep(0); // Start met welkomstpagina
    });
  </script>

</body>
</html>
