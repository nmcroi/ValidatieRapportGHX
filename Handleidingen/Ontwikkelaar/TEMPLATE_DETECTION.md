# Template Detection System - TGâ†’Nâ†’O Decision Tree

## ðŸ” **Overview**

The template detection system implements a three-tier decision tree that automatically identifies and processes different types of GHX pricing templates. This system is the foundation of the entire validation pipeline and determines how each template is processed.

## ðŸŒ³ **Decision Tree Logic**

```
Input Excel File
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: TG Check    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â€¢ Check A1 cell     â”‚ â”€â”€â”
â”‚ â€¢ Check headers     â”‚   â”‚ GHX_STAMP found?
â”‚ â€¢ Look for stamp    â”‚   â”‚
â”‚   pattern:          â”‚   â”‚ â”Œâ”€ YES â”€â”€> TG (Template Generator)
â”‚   S-LM-0-0-0-ul-    â”‚   â””â”€â”¤         â”‚
â”‚   V78-M18           â”‚     â”‚         â”œâ”€ Parse stamp metadata
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚         â”œâ”€ Extract institutions
       â”‚                    â”‚         â”œâ”€ Determine product types
       â”‚ NO                 â”‚         â”œâ”€ Calculate field counts
       â–¼                    â”‚         â””â”€ Apply dynamic logic
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ Step 2: N Check     â”‚     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚     â”‚
â”‚ â€¢ Scan column       â”‚ â”€â”€â” â”‚
â”‚   headers           â”‚   â”‚ â”‚
â”‚ â€¢ Look for:         â”‚   â”‚ â”‚
â”‚   "Is Bestelbare    â”‚   â”‚ â”‚ â”Œâ”€ YES â”€â”€> N (Nieuwe Generatie)
â”‚    Eenheid"         â”‚   â””â”€â”¤ â”‚         â”‚
â”‚   "Omschrijving     â”‚     â”‚ â”‚         â”œâ”€ Modern GHX template
â”‚    Verpakkings-     â”‚     â”‚ â”‚         â”œâ”€ Standard validation
â”‚    eenheid"         â”‚     â”‚ â”‚         â””â”€ 17 mandatory fields
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
       â”‚                    â”‚ â”‚
       â”‚ NO                 â”‚ â”‚
       â–¼                    â”‚ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚ Step 3: O Default   â”‚     â”‚ â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€ O (Oude/Alternative)
â”‚ â€¢ Legacy template   â”‚       â””â”€â”¤   â”‚
â”‚ â€¢ Custom format     â”‚         â”‚   â”œâ”€ Header mapping required
â”‚ â€¢ Supplier-specific â”‚         â”‚   â”œâ”€ Legacy compatibility
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â””â”€ Full validation suite
```

## ðŸ“‹ **Template Types Explained**

### TG - Template Generator Templates

**Detection Method:**
- GHX_STAMP in cell A1 or column headers
- Stamp format: `S-LM-0-0-0-ul-V78-M18`
- Contains phrase "deze code niet verwijderen"

**Characteristics:**
- Generated by GHX Template Generator system
- Embedded metadata in stamp code
- Dynamic field configuration
- Institution-specific rules
- Product-type aware validation

**Processing:**
```python
# Example stamp parsing
stamp_code = "S-LM-0-0-0-ul-V78-M18"
parsed_data = {
    'template_choice': 'standard',     # S = Standard, F = Staffel
    'product_types': ['medisch', 'laboratorium'],  # LM = Lab + Medical
    'has_chemicals': False,            # 0 = No chemicals
    'is_staffel_file': False,         # 0 = No staffel pricing
    'gs1_mode': 'ghx_only',           # 0 = GHX only
    'institutions': ['ul'],           # ul = Universiteit Leiden
    'visible_fields': 78,             # V78 = 78 visible fields
    'mandatory_fields': 18            # M18 = 18 mandatory fields
}
```

### N - Nieuwe Generatie Templates

**Detection Method:**
- Presence of "Is BestelbareEenheid" column
- Presence of "Omschrijving Verpakkingseenheid" column
- Modern GHX template structure (post Nov 2024)

**Characteristics:**
- Standardized GHX template format
- Consistent field structure
- 17 standard mandatory fields
- No embedded metadata
- Predictable validation rules

**Processing:**
- Standard GHX field validation
- Fixed mandatory field set
- No header mapping required
- Modern validation rules

### O - Oude/Alternative Templates

**Detection Method:**
- Fallback when neither TG nor N criteria are met
- Legacy templates (pre Nov 2024)
- Supplier-specific formats
- Custom field arrangements

**Characteristics:**
- Requires header mapping
- Variable field structure
- Legacy compatibility needed
- Supplier-specific adaptations

**Processing:**
- Header mapping via `header_mapping.json`
- Flexible field detection
- Legacy validation rules
- Full compatibility mode

## ðŸ› ï¸ **Implementation Details**

### Template Detector Module

```python
# validator/template_detector.py

def determine_template_type(excel_path: str) -> str:
    """
    Main entry point for template detection.
    
    Returns: 'TG', 'N', or 'O'
    """
    # Step 1: Check for TG stamp
    if has_template_generator_stamp(excel_path):
        return "TG"
    
    # Step 2: Check for N markers
    df = pd.read_excel(excel_path, nrows=0)
    columns = [str(col).strip().lower() for col in df.columns]
    
    nieuwe_generatie_markers = [
        'is bestelbarereenheid',
        'omschrijving verpakkingseenheid'
    ]
    
    if any(any(marker in col for col in columns) 
           for marker in nieuwe_generatie_markers):
        return "N"
    
    # Step 3: Default to O
    return "O"
```

### Stamp Detection Logic

```python
def has_template_generator_stamp(excel_path: str) -> bool:
    """
    Detects TG stamp in A1 cell or column headers.
    
    Stamp patterns:
    - A1: "S-LM-0-0-0-ul-V78-M18"
    - Header: "deze code niet verwijderen:\ns-lm-0-0-0-ul-v78-m18"
    """
    # Check A1 cell
    df_cells = pd.read_excel(excel_path, nrows=2, usecols=[0, 1])
    a1_value = str(df_cells.iloc[0, 0]).strip()
    
    if a1_value and (a1_value.startswith("S-") or a1_value.startswith("F-")):
        if "V" in a1_value and "M" in a1_value and "-" in a1_value:
            return True
    
    # Check column headers
    df_headers = pd.read_excel(excel_path, nrows=0)
    for col in df_headers.columns:
        col_str = str(col).lower().strip()
        if "deze code niet verwijderen" in col_str:
            # Parse embedded stamp code
            lines = col_str.split('\n')
            for line in lines:
                if line.startswith(("s-", "f-")) and "v" in line and "m" in line:
                    return True
    
    return False
```

## ðŸ“Š **Template Type Statistics**

Based on processing patterns:

| Template Type | Frequency | Processing Time | Complexity |
|---------------|-----------|-----------------|------------|
| TG            | 60%       | Fast            | High       |
| N             | 25%       | Fast            | Low        |
| O             | 15%       | Medium          | Medium     |

## ðŸŽ¯ **Validation Strategy by Type**

### TG Templates
1. Parse stamp metadata
2. Extract context (institutions, product types)
3. Apply conditional field visibility
4. Use dynamic mandatory field detection
5. Institution-specific validation rules

### N Templates
1. Standard GHX field validation
2. Fixed 17 mandatory fields
3. Modern validation rules
4. No header mapping needed

### O Templates
1. Apply header mapping from `header_mapping.json`
2. Flexible field detection
3. Legacy validation compatibility
4. Comprehensive error handling

## ðŸ”„ **Decision Tree Testing**

```python
# Test utility for decision tree verification
def test_template_detection(excel_path: str) -> Dict[str, Any]:
    """
    Comprehensive template detection testing.
    
    Returns detailed analysis of detection process.
    """
    result = {
        'excel_path': excel_path,
        'template_type': determine_template_type(excel_path),
        'has_tg_stamp': has_template_generator_stamp(excel_path),
        'heeft_nieuwe_generatie_markers': False,
        'gevonden_markers': [],
        'alle_kolommen': [],
        'debug_info': []
    }
    
    # Additional analysis...
    return result
```

## âš¡ **Performance Considerations**

- **Lazy Loading**: Only load headers for initial detection
- **Early Exit**: Stop at first positive match
- **Caching**: Cache detection results for repeated processing
- **Minimal I/O**: Read minimal Excel data for detection

## ðŸš€ **Future Extensions**

The decision tree can be extended to support:
- Additional template types (e.g., 'E' for European templates)
- Version-specific detection (template format versions)
- Multi-language template support
- Custom business rule templates

This flexible architecture ensures the system can adapt to new template formats while maintaining backward compatibility and processing efficiency.